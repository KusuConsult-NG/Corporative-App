const functions = require('firebase-functions');
const admin = require('firebase-admin');
const PDFDocument = require('pdfkit');
const ExcelJS = require('exceljs');

const db = admin.firestore();

/**
 * Export loans to PDF
 * Usage: Call from frontend with userId and optional filters
 */
exports.exportLoansPDF = functions.https.onCall(async (data, context) => {
    // Verify authentication
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'Must be logged in');
    }

    const { userId, filters = {} } = data;

    // Verify user can only export their own loans (unless admin)
    const userDoc = await db.collection('users').doc(context.auth.uid).get();
    const userRole = userDoc.data()?.role;
    const isAdmin = ['admin', 'super_admin', 'customer_care'].includes(userRole);

    if (!isAdmin && userId !== context.auth.uid) {
        throw new functions.https.HttpsError('permission-denied', 'Cannot export other users data');
    }

    try {
        // Fetch loans from Firestore
        let query = db.collection('loans');

        if (!isAdmin) {
            query = query.where('userId', '==', context.auth.uid);
        } else if (userId) {
            query = query.where('userId', '==', userId);
        }

        if (filters.status) {
            query = query.where('status', '==', filters.status);
        }

        const loansSnapshot = await query.get();
        const loans = loansSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Create PDF
        const doc = new PDFDocument({ margin: 50 });
        const chunks = [];

        doc.on('data', (chunk) => chunks.push(chunk));
        doc.on('end', () => { });

        // Header
        doc.fontSize(20).text('AWSLMCSL Loan Report', { align: 'center' });
        doc.moveDown();
        doc.fontSize(12).text(`Generated: ${new Date().toLocaleDateString()}`, { align: 'center' });
        doc.moveDown(2);

        // Table headers
        doc.fontSize(10).font('Helvetica-Bold');
        let yPos = doc.y;
        doc.text('Loan ID', 50, yPos, { width: 80 });
        doc.text('Type', 130, yPos, { width: 100 });
        doc.text('Amount', 230, yPos, { width: 80 });
        doc.text('Status', 310, yPos, { width: 80 });
        doc.text('Date', 390, yPos, { width: 120 });
        doc.moveDown();

        // Draw line under headers
        doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();
        doc.moveDown(0.5);

        // Table content
        doc.font('Helvetica');
        for (const loan of loans) {
            const loanType = loan.loanType?.replace('_', ' ').toUpperCase() || 'N/A';
            const amount = `₦${(loan.amount || 0).toLocaleString()}`;
            const status = loan.status?.toUpperCase() || 'N/A';
            const date = loan.createdAt?.toDate ? loan.createdAt.toDate().toLocaleDateString() : 'N/A';

            yPos = doc.y;
            doc.text(loan.id.substring(0, 8), 50, yPos, { width: 80 });
            doc.text(loanType, 130, yPos, { width: 100 });
            doc.text(amount, 230, yPos, { width: 80 });
            doc.text(status, 310, yPos, { width: 80 });
            doc.text(date, 390, yPos, { width: 120 });
            doc.moveDown();

            // Add new page if needed
            if (doc.y > 700) {
                doc.addPage();
                doc.moveDown();
            }
        }

        // Footer
        doc.moveDown(2);
        doc.fontSize(8).text(`Total Loans: ${loans.length}`, { align: 'center' });

        doc.end();

        // Wait for PDF generation to complete
        const pdfBuffer = await new Promise((resolve) => {
            doc.on('end', () => resolve(Buffer.concat(chunks)));
        });

        // Return base64 encoded PDF
        return {
            success: true,
            data: pdfBuffer.toString('base64'),
            filename: `loans_${new Date().getTime()}.pdf`,
            mimeType: 'application/pdf'
        };

    } catch (error) {
        console.error('Error generating PDF:', error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});

/**
 * Export loans to Excel
 */
exports.exportLoansExcel = functions.https.onCall(async (data, context) => {
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'Must be logged in');
    }

    const { userId, filters = {} } = data;

    // Verify permissions
    const userDoc = await db.collection('users').doc(context.auth.uid).get();
    const userRole = userDoc.data()?.role;
    const isAdmin = ['admin', 'super_admin', 'customer_care'].includes(userRole);

    if (!isAdmin && userId !== context.auth.uid) {
        throw new functions.https.HttpsError('permission-denied', 'Cannot export other users data');
    }

    try {
        // Fetch loans
        let query = db.collection('loans');

        if (!isAdmin) {
            query = query.where('userId', '==', context.auth.uid);
        } else if (userId) {
            query = query.where('userId', '==', userId);
        }

        if (filters.status) {
            query = query.where('status', '==', filters.status);
        }

        const loansSnapshot = await query.get();
        const loans = loansSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Create Excel workbook
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'AWSLMCSL App';
        workbook.created = new Date();

        const worksheet = workbook.addWorksheet('Loans');

        // Define columns
        worksheet.columns = [
            { header: 'Loan ID', key: 'id', width: 20 },
            { header: 'Loan Type', key: 'loanType', width: 20 },
            { header: 'Amount (₦)', key: 'amount', width: 15 },
            { header: 'Interest Rate (%)', key: 'interestRate', width: 15 },
            { header: 'Total Repayment (₦)', key: 'totalRepayment', width: 18 },
            { header: 'Duration (months)', key: 'duration', width: 15 },
            { header: 'Status', key: 'status', width: 12 },
            { header: 'Created Date', key: 'createdAt', width: 18 },
            { header: 'Approved Date', key: 'approvedAt', width: 18 }
        ];

        // Style header row
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF4472C4' }
        };
        worksheet.getRow(1).font = { color: { argb: 'FFFFFFFF' }, bold: true };

        // Add data rows
        loans.forEach(loan => {
            worksheet.addRow({
                id: loan.id,
                loanType: loan.loanType?.replace('_', ' ').toUpperCase(),
                amount: loan.amount || 0,
                interestRate: loan.interestRate || 0,
                totalRepayment: loan.totalRepayment || 0,
                duration: loan.duration || 0,
                status: loan.status?.toUpperCase(),
                createdAt: loan.createdAt?.toDate ? loan.createdAt.toDate().toLocaleDateString() : '',
                approvedAt: loan.approvedAt?.toDate ? loan.approvedAt.toDate().toLocaleDateString() : ''
            });
        });

        // Format amount columns as currency
        worksheet.getColumn('amount').numFmt = '₦#,##0.00';
        worksheet.getColumn('totalRepayment').numFmt = '₦#,##0.00';

        // Generate Excel buffer
        const buffer = await workbook.xlsx.writeBuffer();

        return {
            success: true,
            data: buffer.toString('base64'),
            filename: `loans_${new Date().getTime()}.xlsx`,
            mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        };

    } catch (error) {
        console.error('Error generating Excel:', error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});

/**
 * Export members to Excel (Admin only)
 */
exports.exportMembersExcel = functions.https.onCall(async (data, context) => {
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'Must be logged in');
    }

    // Verify admin access
    const userDoc = await db.collection('users').doc(context.auth.uid).get();
    const userRole = userDoc.data()?.role;
    const isAdmin = ['admin', 'super_admin'].includes(userRole);

    if (!isAdmin) {
        throw new functions.https.HttpsError('permission-denied', 'Admin access required');
    }

    try {
        // Fetch all members
        const membersSnapshot = await db.collection('users').get();
        const members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Create Excel workbook
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Members');

        // Define columns
        worksheet.columns = [
            { header: 'Member ID', key: 'memberId', width: 15 },
            { header: 'Full Name', key: 'fullName', width: 25 },
            { header: 'Email', key: 'email', width: 30 },
            { header: 'Phone', key: 'phone', width: 15 },
            { header: 'Position', key: 'position', width: 20 },
            { header: 'Department', key: 'department', width: 20 },
            { header: 'Role', key: 'role', width: 15 },
            { header: 'Status', key: 'status', width: 12 },
            { header: 'Email Verified', key: 'emailVerified', width: 15 },
            { header: 'Registration Fee', key: 'registrationFeePaid', width: 15 },
            { header: 'Joined Date', key: 'createdAt', width: 18 }
        ];

        // Style header
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF4472C4' }
        };
        worksheet.getRow(1).font = { color: { argb: 'FFFFFFFF' }, bold: true };

        // Add data
        members.forEach(member => {
            worksheet.addRow({
                memberId: member.memberId || '',
                fullName: `${member.firstName || ''} ${member.middleName || ''} ${member.lastName || ''}`.trim(),
                email: member.email || '',
                phone: member.phone || '',
                position: member.position || '',
                department: member.department || '',
                role: member.role?.toUpperCase() || 'MEMBER',
                status: member.status?.toUpperCase() || 'ACTIVE',
                emailVerified: member.emailVerified ? 'Yes' : 'No',
                registrationFeePaid: member.registrationFeePaid ? 'Yes' : 'No',
                createdAt: member.createdAt?.toDate ? member.createdAt.toDate().toLocaleDateString() : ''
            });
        });

        const buffer = await workbook.xlsx.writeBuffer();

        return {
            success: true,
            data: buffer.toString('base64'),
            filename: `members_${new Date().getTime()}.xlsx`,
            mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        };

    } catch (error) {
        console.error('Error generating Excel:', error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});

/**
 * Export savings statement to PDF
 */
exports.exportSavingsPDF = functions.https.onCall(async (data, context) => {
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'Must be logged in');
    }

    const { userId } = data;

    // Verify permissions
    const userDoc = await db.collection('users').doc(context.auth.uid).get();
    const userRole = userDoc.data()?.role;
    const isAdmin = ['admin', 'super_admin', 'customer_care'].includes(userRole);

    if (!isAdmin && userId !== context.auth.uid) {
        throw new functions.https.HttpsError('permission-denied', 'Cannot export other users data');
    }

    try {
        // Get user details
        const targetUserDoc = await db.collection('users').doc(userId).get();
        const userData = targetUserDoc.data();

        // Get savings data
        const savingsSnapshot = await db.collection('savings')
            .where('userId', '==', userId)
            .get();

        const savingsData = savingsSnapshot.docs[0]?.data() || {};

        // Get transactions
        const transactionsSnapshot = await db.collection('wallet_transactions')
            .where('memberId', '==', userData.memberId)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();

        const transactions = transactionsSnapshot.docs.map(doc => doc.data());

        // Create PDF
        const doc = new PDFDocument({ margin: 50 });
        const chunks = [];

        doc.on('data', (chunk) => chunks.push(chunk));
        doc.on('end', () => { });

        // Header
        doc.fontSize(22).text('AWSLMCSL', { align: 'center' });
        doc.fontSize(16).text('Savings Statement', { align: 'center' });
        doc.moveDown();
        doc.fontSize(10).text(`Generated: ${new Date().toLocaleDateString()}`, { align: 'center' });
        doc.moveDown(2);

        // Member details
        doc.fontSize(12).font('Helvetica-Bold').text('Member Information');
        doc.moveDown(0.5);
        doc.font('Helvetica').fontSize(10);
        doc.text(`Name: ${userData.firstName} ${userData.lastName}`);
        doc.text(`Member ID: ${userData.memberId}`);
        doc.text(`Email: ${userData.email}`);
        doc.moveDown(2);

        // Savings summary
        doc.font('Helvetica-Bold').fontSize(12).text('Savings Summary');
        doc.moveDown(0.5);
        doc.font('Helvetica').fontSize(10);
        doc.text(`Current Balance: ₦${(savingsData.balance || 0).toLocaleString()}`);
        doc.text(`Target Amount: ₦${(savingsData.target || 0).toLocaleString()}`);
        doc.moveDown(2);

        // Recent transactions
        doc.font('Helvetica-Bold').fontSize(12).text('Recent Transactions');
        doc.moveDown(0.5);

        // Transaction table header
        doc.fontSize(9).font('Helvetica-Bold');
        let yPos = doc.y;
        doc.text('Date', 50, yPos, { width: 100 });
        doc.text('Type', 150, yPos, { width: 80 });
        doc.text('Amount', 230, yPos, { width: 100 });
        doc.text('Description', 330, yPos, { width: 200 });
        doc.moveDown();
        doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();
        doc.moveDown(0.5);

        // Transaction rows
        doc.font('Helvetica').fontSize(9);
        for (const txn of transactions) {
            yPos = doc.y;
            const date = txn.createdAt?.toDate ? txn.createdAt.toDate().toLocaleDateString() : 'N/A';
            const type = txn.type?.toUpperCase() || '';
            const amount = `₦${(txn.amount || 0).toLocaleString()}`;
            const description = txn.description || '';

            doc.text(date, 50, yPos, { width: 100 });
            doc.text(type, 150, yPos, { width: 80 });
            doc.text(amount, 230, yPos, { width: 100 });
            doc.text(description, 330, yPos, { width: 200 });
            doc.moveDown();

            if (doc.y > 700) {
                doc.addPage();
                doc.moveDown();
            }
        }

        doc.end();

        const pdfBuffer = await new Promise((resolve) => {
            doc.on('end', () => resolve(Buffer.concat(chunks)));
        });

        return {
            success: true,
            data: pdfBuffer.toString('base64'),
            filename: `savings_statement_${new Date().getTime()}.pdf`,
            mimeType: 'application/pdf'
        };

    } catch (error) {
        console.error('Error generating savings PDF:', error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});
